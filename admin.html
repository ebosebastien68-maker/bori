<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Promotion Admin</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
  body { font-family: Inter, system-ui, Arial; background:#071023; color:#e6eef6; padding:20px; }
  .card { max-width:900px; margin:auto; background:#0b1220; padding:20px; border-radius:10px; }
  textarea { width:100%; min-height:80px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#071829; color:inherit; margin-bottom:10px; }
  button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; margin-right:5px; font-weight:600; }
  button:disabled { opacity:0.5; cursor:not-allowed; }
  .btn-promote { background:#22c55e; color:#04121a; }
  .btn-promote-all { background:#ff6b6b; color:#200; }
  table { width:100%; margin-top:12px; border-collapse:collapse; display:none; }
  th, td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; }
  #log { background:#06101a; padding:10px; border-radius:8px; margin-top:12px; font-size:13px; max-height:200px; overflow:auto; }
  .error { color:#ff6b6b; }
  .success { color:#22c55e; }
</style>
</head>
<body>
<div class="card">
  <h2>Promotion Admin</h2>
  <p>Entrez les emails des utilisateurs Ã  promouvoir (virgule ou saut de ligne).</p>
  <textarea id="emails" placeholder="exemple@domaine.com"></textarea>
  <div>
    <button id="findBtn" class="btn-promote">Rechercher</button>
    <button id="promoteAllBtn" class="btn-promote-all" disabled>Promouvoir tous</button>
  </div>
  <table id="tbl">
    <thead>
      <tr><th>Email</th><th>User ID</th><th>RÃ´le</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="log">Logs...</div>
</div>

<script type="module">
  // Configuration Supabase
  const SUPABASE_URL = 'https://dyxncefogemtwgpmberd.supabase.co';
  const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImR5eG5jZWZvZ2VtdHdncG1iZXJkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjI0ODg2MTUsImV4cCI6MjA3ODA2NDYxNX0.9RsEopPvU4xSYiruUYYF4T1fWdfI6p_h-ylYOw_eibc';

  // Initialisation du client Supabase
  const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

  const emailsInput = document.getElementById('emails');
  const findBtn = document.getElementById('findBtn');
  const promoteAllBtn = document.getElementById('promoteAllBtn');
  const tbl = document.getElementById('tbl');
  const tbody = tbl.querySelector('tbody');
  const logEl = document.getElementById('log');

  let usersData = [];

  function uiLog(msg, type = 'info'){
    const t = new Date().toLocaleTimeString();
    const className = type === 'error' ? 'error' : type === 'success' ? 'success' : '';
    const logLine = document.createElement('div');
    logLine.className = className;
    logLine.textContent = `[${t}] ${msg}`;
    logEl.insertBefore(logLine, logEl.firstChild);
    console.log(`[${t}]`, msg);
  }

  function normalizeEmails(raw){
    return raw.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean);
  }

  async function fetchProfileByEmail(email){
    try {
      const { data, error } = await supabase
        .from('users_profile')
        .select('user_id,role,email')
        .eq('email', email)
        .maybeSingle();
      
      if (error) {
        uiLog(`Erreur pour ${email}: ${error.message}`, 'error');
        return { data: null, error };
      }
      
      return { data, error: null };
    } catch (err) {
      uiLog(`Exception pour ${email}: ${err.message}`, 'error');
      return { data: null, error: err };
    }
  }

  async function updateRoleToAdmin(user_id){
    try {
      const { data, error } = await supabase
        .from('users_profile')
        .update({ role: 'admin' })
        .eq('user_id', user_id);
      
      return { data, error };
    } catch (err) {
      return { data: null, error: err };
    }
  }

  async function promoteUser(userId, email, rowIndex){
    uiLog(`Promotion de ${email}...`);
    const res = await updateRoleToAdmin(userId);
    
    if(res.error) { 
      uiLog(`âŒ Erreur pour ${email}: ${res.error.message}`, 'error'); 
      return false;
    }
    
    uiLog(`âœ… ${email} promu admin`, 'success');
    
    const userIndex = usersData.findIndex(u => u.id === userId);
    if(userIndex !== -1) usersData[userIndex].role = 'admin';
    
    const rows = tbody.querySelectorAll('tr');
    if(rows[rowIndex]) {
      rows[rowIndex].children[2].textContent = 'admin';
      const btn = rows[rowIndex].querySelector('.prom');
      if(btn) {
        btn.disabled = true;
        btn.textContent = 'âœ“ Promu';
      }
    }
    return true;
  }

  function renderTable(users){
    usersData = users;
    tbody.innerHTML = '';
    
    users.forEach((u, idx) => {
      const tr = document.createElement('tr');
      const hasButton = u.id && u.role !== 'admin';
      tr.innerHTML = `
        <td>${u.email}</td>
        <td>${u.id ?? '<span class="error">Non trouvÃ©</span>'}</td>
        <td>${u.role ?? '-'}</td>
        <td>${hasButton ? '<button class="prom btn-promote">Promouvoir</button>' : (u.role === 'admin' ? 'âœ“ DÃ©jÃ  admin' : '-')}</td>
      `;
      tbody.appendChild(tr);
      
      if(hasButton){
        tr.querySelector('.prom').addEventListener('click', async () => {
          await promoteUser(u.id, u.email, idx);
        });
      }
    });
  }

  findBtn.addEventListener('click', async () => {
    const emails = normalizeEmails(emailsInput.value);
    if (!emails.length) { 
      uiLog('âš ï¸ Aucun email saisi', 'error'); 
      return; 
    }
    
    uiLog(`ðŸ” Recherche de ${emails.length} profil(s)...`);
    findBtn.disabled = true;

    const found = [];
    for(const email of emails){
      const { data, error } = await fetchProfileByEmail(email);
      if(error || !data){ 
        found.push({email, id:null, role:null}); 
        uiLog(`âŒ ${email} non trouvÃ©`, 'error');
      } else {
        found.push({ email, id: data.user_id, role: data.role });
        uiLog(`âœ“ ${email} trouvÃ© (${data.role})`);
      }
    }

    renderTable(found);
    tbl.style.display = found.length ? 'table' : 'none';
    
    const promotable = found.filter(f => f.id && f.role !== 'admin').length;
    promoteAllBtn.disabled = promotable === 0;
    
    if(promotable > 0) {
      uiLog(`${promotable} utilisateur(s) prÃªt(s) Ã  Ãªtre promu(s)`, 'success');
    }
    
    findBtn.disabled = false;
  });

  promoteAllBtn.addEventListener('click', async () => {
    const toPromote = usersData.filter(u => u.id && u.role !== 'admin');
    if(!toPromote.length) return;
    
    if(!confirm(`Promouvoir ${toPromote.length} utilisateur(s) en admin ?`)) return;
    
    promoteAllBtn.disabled = true;
    findBtn.disabled = true;
    uiLog(`ðŸš€ DÃ©but de la promotion de ${toPromote.length} utilisateur(s)`);
    
    let success = 0;
    for(let i = 0; i < toPromote.length; i++){
      const user = toPromote[i];
      const rowIndex = usersData.findIndex(u => u.id === user.id);
      const result = await promoteUser(user.id, user.email, rowIndex);
      if(result) success++;
      await new Promise(r => setTimeout(r, 300));
    }
    
    uiLog(`âœ… Promotion terminÃ©e: ${success}/${toPromote.length} rÃ©ussie(s)`, 'success');
    promoteAllBtn.disabled = true;
    findBtn.disabled = false;
  });

  uiLog('âœ… Interface prÃªte');
</script>
</body>
</html>
