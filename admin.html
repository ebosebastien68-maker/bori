<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width,initial-scale=1.0">
<title>Promouvoir plusieurs utilisateurs en admin</title>
<style>
  :root {
    --bg:#0f1724; --card:#0b1220; --muted:#9aa4b2; --accent:#6ee7b7; --danger:#ff6b6b;
    font-family: Inter, ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, "Helvetica Neue", Arial;
  }
  body{margin:0;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;background:linear-gradient(180deg,#071023,#071829);color:#e6eef6;padding:24px;-webkit-font-smoothing:antialiased;}
  .card{width:900px;max-width:96vw;background:var(--card);border-radius:16px;padding:22px;box-shadow:0 6px 30px rgba(2,6,23,0.6);border:1px solid rgba(255,255,255,0.03);}
  h1{margin:0 0 8px;font-size:20px}
  p.lead{margin:0 0 18px;color:var(--muted);font-size:13px}
  textarea{width:100%;background:rgba(255,255,255,0.03);padding:12px;border-radius:10px;border:1px solid rgba(255,255,255,0.02);color:inherit;font-size:14px;resize:none;}
  .btn{background:linear-gradient(90deg,#22c55e,#16a34a);color:#04121a;padding:10px 14px;border-radius:10px;border:none;cursor:pointer;font-weight:600;display:inline-flex;gap:8px;align-items:center;user-select:none;}
  .btn:disabled{opacity:0.5;cursor:default;}
  .btn-danger{background:linear-gradient(90deg,#ff7b7b,#ff4d4d);color:#1f0f0f;}
  table{width:100%;border-collapse:collapse;margin-top:14px;}
  th,td{padding:8px;border-bottom:1px solid rgba(255,255,255,0.1);text-align:left;}
  th{color:var(--muted);}
  .status{margin-top:14px;font-size:13px;min-height:20px;color:var(--muted);}
  .success{color:var(--accent);font-weight:600;}
  .error{color:var(--danger);font-weight:600;}
</style>
</head>
<body>

<div class="card">
  <h1>Promouvoir plusieurs utilisateurs en admin</h1>
  <p class="lead">Saisis une ou plusieurs emails (séparés par virgule ou retour à la ligne). Les utilisateurs trouvés seront listés et peuvent être promus en admin.</p>

  <textarea id="emails" rows="4" placeholder="Ex : jean@example.com&#10;maria@example.com"></textarea>
  <div style="margin-top:12px;">
    <button id="findBtn" class="btn">Rechercher</button>
    <button id="promoteAllBtn" class="btn btn-danger" disabled>Promouvoir tous en admin</button>
  </div>

  <div class="status" id="status"></div>

  <table id="userTable" style="display:none;margin-top:12px;">
    <thead>
      <tr>
        <th>Email</th>
        <th>User ID</th>
        <th>Rôle actuel</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

</div>

<script type="module">
import { supabase } from './supabaseClient.js';

const emailsInput = document.getElementById('emails');
const findBtn = document.getElementById('findBtn');
const promoteAllBtn = document.getElementById('promoteAllBtn');
const userTable = document.getElementById('userTable');
const tbody = userTable.querySelector('tbody');
const statusEl = document.getElementById('status');

let usersList = []; // {email, id, role}

function setStatus(text, kind){ statusEl.textContent=text||''; statusEl.className=kind||''; }

async function findUsers(){
  let emails = emailsInput.value.split(/[\n,]+/).map(e=>e.trim()).filter(Boolean);
  if(!emails.length){ setStatus('Renseigne au moins un e-mail.', 'error'); return; }

  setStatus('Recherche en cours...', '');
  tbody.innerHTML='';
  usersList=[];

  for(const email of emails){
    try{
      const { data:user, error } = await supabase
        .from('auth.users')
        .select('id, email')
        .eq('email', email)
        .single();

      if(error || !user){
        tbody.innerHTML += `<tr><td>${email}</td><td>-</td><td>-</td><td style="color:var(--danger)">Non trouvé</td></tr>`;
      } else {
        const { data: profileData } = await supabase
          .from('users_profile')
          .select('role')
          .eq('user_id', user.id)
          .single();

        const role = profileData?.role || 'user';
        usersList.push({email:user.email,id:user.id,role});
        tbody.innerHTML += `<tr>
          <td>${user.email}</td>
          <td>${user.id}</td>
          <td>${role}</td>
          <td><button class="btn btn-danger" data-id="${user.id}">Promouvoir</button></td>
        </tr>`;
      }
    }catch(err){
      tbody.innerHTML += `<tr><td>${email}</td><td>-</td><td>-</td><td style="color:var(--danger)">Erreur</td></tr>`;
    }
  }

  userTable.style.display='table';
  promoteAllBtn.disabled = usersList.length===0;

  // ajouter événements boutons individuels
  tbody.querySelectorAll('button[data-id]').forEach(btn=>{
    btn.addEventListener('click', ()=>promoteUser(btn.dataset.id));
  });
}

async function promoteUser(user_id){
  if(!confirm('Promouvoir cet utilisateur en admin ?')) return;
  try{
    const { data, error } = await supabase
      .from('users_profile')
      .update({ role:'admin' })
      .eq('user_id', user_id);
    if(error){ setStatus('Erreur promotion.', 'error'); console.log(error); return; }
    setStatus('Utilisateur promu avec succès.', 'success');
    findUsers(); // rafraîchir la liste
  }catch(err){ setStatus('Erreur.', 'error'); console.log(err); }
}

async function promoteAll(){
  if(!confirm('Promouvoir tous les utilisateurs listés en admin ?')) return;
  for(const user of usersList){
    await promoteUser(user.id);
  }
}

findBtn.addEventListener('click', findUsers);
promoteAllBtn.addEventListener('click', promoteAll);
</script>

</body>
</html>
