<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Promotion Admin</title>
<style>
  body { font-family: Inter, system-ui, Arial; background:#071023; color:#e6eef6; padding:20px; }
  .card { max-width:900px; margin:auto; background:#0b1220; padding:20px; border-radius:10px; }
  textarea { width:100%; min-height:80px; padding:10px; border-radius:8px; border:1px solid rgba(255,255,255,0.03); background:#071829; color:inherit; margin-bottom:10px; }
  button { padding:8px 12px; border-radius:8px; border:none; cursor:pointer; margin-right:5px; font-weight:600; }
  .btn-promote { background:#22c55e; color:#04121a; }
  .btn-promote-all { background:#ff6b6b; color:#200; }
  table { width:100%; margin-top:12px; border-collapse:collapse; display:none; }
  th, td { padding:8px; border-bottom:1px solid rgba(255,255,255,0.04); text-align:left; }
  #log { background:#06101a; padding:10px; border-radius:8px; margin-top:12px; font-size:13px; max-height:200px; overflow:auto; }
</style>
</head>
<body>
<div class="card">
  <h2>Promotion Admin</h2>
  <p>Entrez les emails des utilisateurs à promouvoir (virgule ou saut de ligne).</p>
  <textarea id="emails" placeholder="exemple@domaine.com"></textarea>
  <div>
    <button id="findBtn" class="btn-promote">Rechercher</button>
    <button id="promoteAllBtn" class="btn-promote-all" disabled>Promouvoir tous</button>
  </div>
  <table id="tbl">
    <thead>
      <tr><th>Email</th><th>User ID</th><th>Rôle</th><th>Action</th></tr>
    </thead>
    <tbody></tbody>
  </table>
  <div id="log">Logs...</div>
</div>

<script type="module">
  // Vérifie que le client Supabase est chargé
  const supabase = window.supabaseClient?.supabase;
  if (!supabase) {
    console.error("Supabase client non disponible. Vérifiez que supabaseClient.js est chargé.");
  }

  const emailsInput = document.getElementById('emails');
  const findBtn = document.getElementById('findBtn');
  const promoteAllBtn = document.getElementById('promoteAllBtn');
  const tbl = document.getElementById('tbl');
  const tbody = tbl.querySelector('tbody');
  const logEl = document.getElementById('log');

  function uiLog(...args){
    const t = new Date().toLocaleTimeString();
    logEl.textContent = `[${t}] ${args.map(a=>typeof a==='string'?a:JSON.stringify(a)).join(' ')}\n` + logEl.textContent;
    console.log(...args);
  }

  function normalizeEmails(raw){
    return raw.split(/[\n,;]+/).map(s=>s.trim()).filter(Boolean);
  }

  async function fetchProfileByEmail(email){
    const { data, error } = await supabase.from('users_profile').select('user_id,role').eq('email', email).maybeSingle();
    if (error) uiLog('Erreur fetchProfileByEmail', error);
    return { data, error };
  }

  async function updateRoleToAdmin(user_id){
    const { data, error } = await supabase.from('users_profile').update({ role: 'admin' }).eq('user_id', user_id);
    return { data, error };
  }

  function renderTable(users){
    tbody.innerHTML = '';
    users.forEach(u => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${u.email}</td><td>${u.id??'-'}</td><td>${u.role??'-'}</td><td>${u.id?'<button class="prom">Promouvoir</button>':'-'}</td>`;
      tbody.appendChild(tr);
      if(u.id){
        tr.querySelector('.prom').addEventListener('click', async () => {
          uiLog('Promouvoir', u.id);
          const res = await updateRoleToAdmin(u.id);
          if(res.error) { uiLog('Erreur update', res.error); alert('Erreur: '+(res.error.message||res.error)); return; }
          uiLog('Utilisateur promu', u.id);
          tr.children[2].textContent = 'admin';
        });
      }
    });
  }

  findBtn.addEventListener('click', async () => {
    const emails = normalizeEmails(emailsInput.value);
    if (!emails.length) { uiLog('Aucun email saisi'); return; }
    uiLog('Recherche des profils', emails);

    const found = [];
    for(const email of emails){
      const { data, error } = await fetchProfileByEmail(email);
      if(error || !data){ found.push({email, id:null, role:null}); continue; }
      found.push({ email, id: data.user_id, role: data.role });
    }

    renderTable(found);
    tbl.style.display = found.length ? 'table' : 'none';
    promoteAllBtn.disabled = found.filter(f=>f.id).length === 0;
  });

  promoteAllBtn.addEventListener('click', async () => {
    const btns = Array.from(document.querySelectorAll('.prom'));
    if(!btns.length) return;
    if(!confirm(`Promouvoir ${btns.length} utilisateur(s) ?`)) return;
    for(const b of btns){
      b.disabled = true;
      b.click();
      await new Promise(r=>setTimeout(r, 200));
      b.disabled = false;
    }
  });

  uiLog('Interface prête, vérifiez la console pour plus de détails.');
</script>
</body>
</html>
